<!DOCTYPE html>

<html>
<head>
  <title>router.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="./docco.css" />
</head>
<body>
<div id="container">
  <table cellspacing="0" cellpadding="0">
    <thead>
    <tr>
      <th class="docs">
        
        <h1>router.js</h1>
        
      </th>
      <th class="code"></th>
    </tr>
    </thead>
    <tbody>
    
    
    <tr id="section-1">
      <td class="docs">
        <div class="octowrap">
          <a class="octothorpe" href="#section-1">#</a>
        </div>
      <h1 id="therouter">The router</h1>

<p>The <strong>router</strong> is a component intended to map URLs with views.
In a MVC, the <strong>router</strong> is part of the controller. There are several routing
mechanisms; here we use a simple and didactical one to provide several
examples of advanced JavaScript uses.</p>

<p>Our proposal is to split our single-page application into several
<em>navigation sections</em>, each identified by the custom attribute
<code>data-navigation-section</code>. When detecting a route, the application will move
to that section by hidding the current one and showing the new one.</p>
      </td>
      <td class="code">
      <pre><code >

<span class="undefined"></span></code></pre>
      </td>
    </tr>
    
    
    <tr id="section-2">
      <td class="docs">
        <div class="octowrap">
          <a class="octothorpe" href="#section-2">#</a>
        </div>
      <h2 id="thecode">The code</h2>
      </td>
      <td class="code">
      <pre><code >

<span class="undefined"></span></code></pre>
      </td>
    </tr>
    
    
    <tr id="section-3">
      <td class="docs">
        <div class="octowrap">
          <a class="octothorpe" href="#section-3">#</a>
        </div>
      <p>An object with pairs of <strong>pattern</strong> and <strong>action</strong>.</p>

<p>Each <strong>pattern</strong> is a <a href="https://developer.mozilla.org/en/docs/Web/JavaScript/Guide/Regular_Expressions">regular expression</a>
that will be matched against the path of the URL. We use parenthesis to
indicate parts of the URL to be remembered and passed to the initialization
callback.</p>

<p><strong>Actions</strong> are pairs of section and view function. The view function will be
in charge of populate the section and add the extra functionallity.</p>
      </td>
      <td class="code">
      <pre><code >
var ROUTES = {
  <span class="comment">'^/$':                    ['post-list', fakeViewInitializer],</span>
  <span class="comment">'/posts/?$':             ['post-list', fakeViewInitializer],</span>
  <span class="comment">'/posts/(\\d+)/?$':      ['show-post', fakeViewInitializer],</span>
  <span class="comment">'/posts/(\\d+)/edit/?$': ['edit-post', fakeViewInitializer],</span>
  <span class="comment">'/posts/new/?$':         ['new-post', fakeViewInitializer]</span>
};

</code></pre>
      </td>
    </tr>
    
    
    <tr id="section-4">
      <td class="docs">
        <div class="octowrap">
          <a class="octothorpe" href="#section-4">#</a>
        </div>
      <p>In the complete application, going to a section will trigger some initialization
actions such as fetching data from server and installing special handlers for
specific actions. We are simulating this initialization now by simply printing
the parameters in the console.</p>
      </td>
      <td class="code">
      <pre><code >
<span class="function"><span class="keyword">function</span> <span class="title">fakeViewInitializer</span><span class="params">(section, querystringParams)</span> {</span>
  <span class="string">'use strict'</span>

  var capturedGroups = <span class="transposed_variable">Array.</span><span class="transposed_variable">prototype.</span><span class="transposed_variable">slice.</span>call(arguments, <span class="number">2</span>);
  <span class="transposed_variable">console.</span><span class="built_in">log</span>(<span class="string">'Section:'</span>, section);
  <span class="transposed_variable">console.</span><span class="built_in">log</span>(<span class="string">'Querystring parameters:'</span>, <span class="transposed_variable">JSON.</span>stringify(querystringParams));
  <span class="transposed_variable">console.</span><span class="built_in">log</span>(<span class="string">'Path parameters:'</span>, capturedGroups + <span class="string">''</span>);
}

</code></pre>
      </td>
    </tr>
    
    
    <tr id="section-5">
      <td class="docs">
        <div class="octowrap">
          <a class="octothorpe" href="#section-5">#</a>
        </div>
      <p>We are not isolating the code right now so we mark the <em>private</em> variables by
prepending a dash (<code>_</code>) before the name. Just a naming convention.</p>
      </td>
      <td class="code">
      <pre><code >
<span class="title">var</span> _currentLinks, _currentSection, _navigationSections;

</code></pre>
      </td>
    </tr>
    
    
    <tr id="section-6">
      <td class="docs">
        <div class="octowrap">
          <a class="octothorpe" href="#section-6">#</a>
        </div>
      <p>A clean code reccommendation is to start with running code as soon as possible
and write dependencies just below. This way you don't read a lot of code pieces
you don't know how they interact but just the working piece of code. It is your
choice if I want to go deeper or not.</p>
      </td>
      <td class="code">
      <pre><code >
<span class="function"><span class="title">startRouter</span><span class="params">()</span>;

<span class="title">function</span> <span class="title">startRouter</span><span class="params">()</span> {
  </code></pre>
      </td>
    </tr>
    
    
    <tr id="section-7">
      <td class="docs">
        <div class="octowrap">
          <a class="octothorpe" href="#section-7">#</a>
        </div>
      <p>The <code>'use-strict'</code> pragma is no more than a string telling the JavaScript
  interpreter we want run this code in <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Functions_and_function_scope/Strict_mode">strict mode</a>.
  It has function scope, meaning only the code inside the function with the
  pragma will be run in strict mode. It is quite important to not write
  <code>'use-strict'</code> as a global because this will force <strong>all the code</strong> to be
  run this way causing incompatibilites where legacy mode is still neccessary.</p>
      </td>
      <td class="code">
      <pre><code >
  <span class="attribute">'use</span> strict'

  </code></pre>
      </td>
    </tr>
    
    
    <tr id="section-8">
      <td class="docs">
        <div class="octowrap">
          <a class="octothorpe" href="#section-8">#</a>
        </div>
      <p>Here we check for <a href="https://developer.mozilla.org/en-US/docs/Web/API/document.readyState">document state</a>,
  if all the DOM has been parsed, install the router and forces firs navigation.
  If not, <a href="https://developer.mozilla.org/en-US/docs/Web/Reference/Events/DOMContentLoaded">wait for DOM to be completely loaded</a>.</p>
      </td>
      <td class="code">
      <pre><code >
  <span class="keyword">if</span> (<span class="transposed_variable">document.</span>readyState !== <span class="string">'loading'</span>) <span class="cell">{
    installRouterAndNavigate();
  }</span>
  <span class="keyword">else</span> <span class="cell">{
    document.addEventListener(<span class="string">'DOMContentLoaded'</span>, installRouterAndNavigate);
  }</span>

  </code></pre>
      </td>
    </tr>
    
    
    <tr id="section-9">
      <td class="docs">
        <div class="octowrap">
          <a class="octothorpe" href="#section-9">#</a>
        </div>
      <p>As our history state is the URL (a very Webby approach), to show the proper
  view we should only <em>client-navigate</em> to that URL.</p>
      </td>
      <td class="code">
      <pre><code >
  <span class="transposed_variable">window.</span>onpopstate = <span class="function"><span class="keyword">function</span> <span class="params">(event)</span> {</span>
    <span class="keyword">if</span> (<span class="transposed_variable">event.</span>state) <span class="cell">{
      navigateTo(event.state);
    }</span>
  };

  </code></pre>
      </td>
    </tr>
    
    
    <tr id="section-10">
      <td class="docs">
        <div class="octowrap">
          <a class="octothorpe" href="#section-10">#</a>
        </div>
      <p>As you can see, functions can be nested inside functions. Here we use an
  inner function to reduce code repetition.</p>
      </td>
      <td class="code">
      <pre><code >
  function installRouterAndNavigate() {
    updateNavigation()<span class="comment">;</span>
    autodiscoverSections()<span class="comment">;</span>
    hideAllSections()<span class="comment">;</span>
    navigateTo(window<span class="preprocessor">.location</span><span class="preprocessor">.pathname</span>)<span class="comment">;</span>
  }
}

</code></pre>
      </td>
    </tr>
    
    
    <tr id="section-11">
      <td class="docs">
        <div class="octowrap">
          <a class="octothorpe" href="#section-11">#</a>
        </div>
      <p>We are taking advantage of normal link elements, <code>&lt;a&gt;</code> to control navigation by
overwritting what to do when clicking on a link.</p>
      </td>
      <td class="code">
      <pre><code >
<span class="function"><span class="keyword">function</span> <span class="title">updateNavigation</span><span class="params">()</span> {</span>
  <span class="string">'use strict'</span>

  </code></pre>
      </td>
    </tr>
    
    
    <tr id="section-12">
      <td class="docs">
        <div class="octowrap">
          <a class="octothorpe" href="#section-12">#</a>
        </div>
      <p>The list returned by <code>getElementsByTagName()</code> is what JS call a
  <strong>live list</strong>. A live list does not need to be updated any more because it
  always contains the list of elements matching the performed query. This case
  is the list of all <code>&lt;a&gt;</code> elements.</p>
      </td>
      <td class="code">
      <pre><code >
  <span class="keyword">if</span> (!<span class="transposed_variable">window.</span>_currentLinks) <span class="cell">{
    window._currentLinks = document.getElementsByTagName(<span class="string">'a'</span>);
  }</span>

  <span class="keyword">for</span> (var a, <span class="built_in">i</span> = <span class="number">0</span>, l = <span class="transposed_variable">_currentLinks.</span><span class="built_in">length</span>; <span class="built_in">i</span> &lt; l; <span class="built_in">i</span>++) <span class="cell">{
    a = _currentLinks[i]
    a.addEventListener(<span class="string">'click'</span>, doClientNavigation);
  }</span>
}

</code></pre>
      </td>
    </tr>
    
    
    <tr id="section-13">
      <td class="docs">
        <div class="octowrap">
          <a class="octothorpe" href="#section-13">#</a>
        </div>
      <p>Fill the navigation sections found in the SPA. It uses an object to
automatically avoid repetitions. You can extract the keys of an object
by using <code>Object.keys()</code> method.</p>
      </td>
      <td class="code">
      <pre><code >
<span class="function"><span class="keyword">function</span> <span class="title">autodiscoverSections</span><span class="params">()</span> {</span>
  <span class="string">'use strict'</span>

  <span class="keyword">if</span> (!_navigationSections) <span class="cell">{
  </code></pre>
      </td>
    </tr>
    
    
    <tr id="section-14">
      <td class="docs">
        <div class="octowrap">
          <a class="octothorpe" href="#section-14">#</a>
        </div>
      <p>With <code>Object.create()</code> we create a new object with its prototype set to the
  passed object. Passing <code>null</code> the object has no prototype: it is the simplest
  object possible.</p>
      </td>
      <td class="code">
      <pre><code >
    _navigationSections = <span class="transposed_variable">Object.</span>create(null);
  }

  var navigationSections =
    <span class="transposed_variable">document.</span>querySelectorAll(<span class="string">'[data-navigation-section]'</span>);

  <span class="keyword">for</span> (var section, <span class="built_in">i</span> = <span class="number">0</span>, l = <span class="transposed_variable">navigationSections.</span><span class="built_in">length</span>; <span class="built_in">i</span> &lt; l; <span class="built_in">i</span>++) <span class="cell">{
    section = navigationSections[i].dataset.navigationSection;
    _navigationSections[section] = true;
  }</span>
}

<span class="function"><span class="keyword">function</span> <span class="title">doClientNavigation</span><span class="params">(evt)</span> {</span>
  <span class="string">'use strict'</span>

  </code></pre>
      </td>
    </tr>
    
    
    <tr id="section-15">
      <td class="docs">
        <div class="octowrap">
          <a class="octothorpe" href="#section-15">#</a>
        </div>
      <p>By calling <code>preventDefault()</code> we avoid the default action of the link which
  is navigate to the <code>href</code> URL by performing a <code>GET</code> request to the server.</p>
      </td>
      <td class="code">
      <pre><code >
  <span class="transposed_variable">evt.</span>preventDefault();
  <span class="transposed_variable">evt.</span>stopPropagation();
  navigateTo(<span class="transposed_variable">evt.</span><span class="transposed_variable">target.</span>getAttribute(<span class="string">'href'</span>));
}

<span class="function"><span class="keyword">function</span> <span class="title">hideAllSections</span><span class="params">()</span> {</span>
  <span class="string">'use strict'</span>

  <span class="transposed_variable">Object.</span>keys(_navigationSections).forEach(<span class="function"><span class="keyword">function</span> <span class="params">(sectionName)</span> {</span>
     hideSection(sectionName);
  });
}

<span class="function"><span class="keyword">function</span> <span class="title">hideSection</span><span class="params">(sectionName)</span> {</span>
  <span class="string">'use strict'</span>

  setSectionVisibility(sectionName, false);
}

<span class="function"><span class="keyword">function</span> <span class="title">showSection</span><span class="params">(sectionName)</span> {</span>
  <span class="string">'use strict'</span>

  setSectionVisibility(sectionName, true);
}

<span class="function"><span class="keyword">function</span> <span class="title">setSectionVisibility</span><span class="params">(sectionName, visibility)</span> {</span>
  <span class="string">'use strict'</span>

  </code></pre>
      </td>
    </tr>
    
    
    <tr id="section-16">
      <td class="docs">
        <div class="octowrap">
          <a class="octothorpe" href="#section-16">#</a>
        </div>
      <p>New JavaScript <code>querySelector()</code> and <code>querySelectorAll()</code> methods mimic the
  famous <em>jQuery</em> behavior and allow CSS selector to query the DOM for a
  collection of the elements matching the CSS selector provided. Here we are
  using an <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/Attribute_selectors">attribute selector</a>.</p>
      </td>
      <td class="code">
      <pre><code >
  var selector = <span class="string">'[data-navigation-section="'</span> + sectionName + <span class="string">'"]'</span>;
  var navParts = <span class="transposed_variable">document.</span>querySelectorAll(selector);
  <span class="keyword">for</span> (var l = <span class="transposed_variable">navParts.</span><span class="built_in">length</span> - <span class="number">1</span>, part; part = navParts<span class="matrix">[l]</span>; l--) <span class="cell">{
    part.hidden = !visibility;
  }</span>
}

</code></pre>
      </td>
    </tr>
    
    
    <tr id="section-17">
      <td class="docs">
        <div class="octowrap">
          <a class="octothorpe" href="#section-17">#</a>
        </div>
      <p>The function has split its responsibility in two: pattern matching and
DOM changes. Here the pattern matching process is attended while DOM changes
are in the next function.</p>
      </td>
      <td class="code">
      <pre><code >
<span class="function"><span class="keyword">function</span> <span class="title">navigateTo</span><span class="params">(href)</span> {</span>
  <span class="string">'use strict'</span>

  <span class="keyword">var</span> routes = window.ROUTES;
  <span class="keyword">var</span> parameters = parseGetParameters(href);

  </code></pre>
      </td>
    </tr>
    
    
    <tr id="section-18">
      <td class="docs">
        <div class="octowrap">
          <a class="octothorpe" href="#section-18">#</a>
        </div>
      <p>New in JavaScript 1.8, <code>&lt;a&gt;</code> elements implement <a href="https://developer.mozilla.org/en-US/docs/Web/API/URLUtils"><code>URLUtils</code></a>
  interface which allow us to use the link as an URL parser.</p>
      </td>
      <td class="code">
      <pre><code >
  var matching, path, parser = document<span class="preprocessor">.createElement</span>(<span class="string">'a'</span>)<span class="comment">;</span>
  parser<span class="preprocessor">.href</span> = href<span class="comment">;</span>
  path = parser<span class="preprocessor">.pathname</span><span class="comment">;</span>

  </code></pre>
      </td>
    </tr>
    
    
    <tr id="section-19">
      <td class="docs">
        <div class="octowrap">
          <a class="octothorpe" href="#section-19">#</a>
        </div>
      <p>The loop pass through each pattern trying to find a match for the current
  path. If found, it call the routing action associated to that pattern passing
  the query parameters as a dictionary and all the groups found in the path.</p>
      </td>
      <td class="code">
      <pre><code >
  for (var pattern <span class="keyword">in</span> routes) if (routes<span class="preprocessor">.hasOwnProperty</span>(pattern)) {
    matching = path<span class="preprocessor">.match</span>(pattern)<span class="comment">;</span>
    if (matching) {
      var args = [parameters]<span class="preprocessor">.concat</span>(matching<span class="preprocessor">.slice</span>(<span class="number">1</span>))<span class="comment">;</span>
      var sectionPair = routes[pattern]<span class="comment">;</span>
      changeToSection(href, sectionPair[<span class="number">0</span>], sectionPair[<span class="number">1</span>], args)<span class="comment">;</span>
      return<span class="comment">;</span>
    }
  }
}

</code></pre>
      </td>
    </tr>
    
    
    <tr id="section-20">
      <td class="docs">
        <div class="octowrap">
          <a class="octothorpe" href="#section-20">#</a>
        </div>
      <p>The function hidesthe current section and shows the new one. Finally calls
the <code>viewFunction</code> callback passing sections name, querystring parameters
and captured groups as arguments.</p>
      </td>
      <td class="code">
      <pre><code >
<span class="function"><span class="keyword">function</span> <span class="title">changeToSection</span><span class="params">(href, sectionName, viewFunction, args)</span> {</span>
  <span class="string">'use strict'</span>

  hideSection(_currentSection);
  _currentSection = sectionName;
  showSection(sectionName);

  </code></pre>
      </td>
    </tr>
    
    
    <tr id="section-21">
      <td class="docs">
        <div class="octowrap">
          <a class="octothorpe" href="#section-21">#</a>
        </div>
      <p>As our URL contains all the information for the view, it suffices to store
  the href as the history state, setting the URL accordingly.</p>
      </td>
      <td class="code">
      <pre><code >
  <span class="transposed_variable">window.</span><span class="transposed_variable">history.</span>pushState(href, <span class="string">''</span>, href);

  <span class="transposed_variable">viewFunction.</span>apply(this, <span class="matrix">[sectionName].</span>concat(args));
}


<span class="function"><span class="keyword">function</span> <span class="title">parseGetParameters</span><span class="params">(href)</span> {</span>
  <span class="string">'use strict'</span>

  </code></pre>
      </td>
    </tr>
    
    
    <tr id="section-22">
      <td class="docs">
        <div class="octowrap">
          <a class="octothorpe" href="#section-22">#</a>
        </div>
      <p>Looking for the querystring of an URL is not hard. Just look for the substring
  following the <code>?</code> character until the end or until finding a <code>#</code> character.</p>
      </td>
      <td class="code">
      <pre><code >
  var matching = <span class="transposed_variable">href.</span>match(/\?(<span class="matrix">[^#]</span>+)/);
  var result = <span class="cell">{}</span>;
  <span class="keyword">if</span> (matching &amp;&amp; <span class="transposed_variable">matching.</span><span class="built_in">length</span> === <span class="number">2</span>) <span class="cell">{
  </code></pre>
      </td>
    </tr>
    
    
    <tr id="section-23">
      <td class="docs">
        <div class="octowrap">
          <a class="octothorpe" href="#section-23">#</a>
        </div>
      <p>Some functional style is presented here. Note how first we split the
  querystring by the <code>&amp;</code> character, then pass through the list items
  applying a second split to separate parameter name and value into tuples.</p>
      </td>
      <td class="code">
      <pre><code >
    var parameters = matching[<span class="number">1</span>]<span class="preprocessor">.split</span>(<span class="string">'&amp;'</span>)<span class="preprocessor">.map</span>(function (parameterSpec) {
      return parameterSpec<span class="preprocessor">.split</span>(<span class="string">'='</span>)<span class="comment">;</span>
    })<span class="comment">;</span>
  </code></pre>
      </td>
    </tr>
    
    
    <tr id="section-24">
      <td class="docs">
        <div class="octowrap">
          <a class="octothorpe" href="#section-24">#</a>
        </div>
      <p>Finally, we iterate through the elements of the array putting them into a
  dictionary.</p>
      </td>
      <td class="code">
      <pre><code >
    <span class="transposed_variable">parameters.</span>forEach(<span class="function"><span class="keyword">function</span> <span class="params">(parameter)</span> {</span>
      result<span class="matrix">[parameter[<span class="number">0</span>]</span>] = parameter<span class="matrix">[<span class="number">1</span>]</span>;
    });
  }
  <span class="keyword">return</span> result;
}
</code></pre>
      </td>
    </tr>
    
  </table>
</div>
</body>
</html>



